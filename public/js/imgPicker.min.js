(function(e){e.fn.extend({imgPicker:function(t){if(typeof t!="object")t={el:t};var n={upload:true,html5Upload:true,webcam:true,width:400,swf_url:"assets/webcam.swf",attr:"src",title:"Edit Image",api:"includes/api.php",timestamp:true},r,t=e.extend(n,t);t.width=t.modalWidth||t.width;var s='<div class="ip-body">'+(t.upload?'<div class="btn btn-primary ip-upload"><span>Upload photo</span><form><input type="file" name="ip-file" class="ip-file"></form></div>':"")+(t.webcam?'<button class="btn btn-info ip-webcam">Webcam</button>':"")+'<div class="alert ip-alert"><span></span> <a class="dismiss">&times;</a></div><div class="cropper-container"><div class="cropper-mask"><div class="cropper-overlay"></div><img class="cropper-image" src=""></div><div class="cropper-slider"><div class="cropper-handle"></div></div></div><div class="webcam-container"><video autoplay></video><div class="preview"></div></div></div><div class="ip-footer"><button class="btn btn-success ip-save">Save</button><button class="btn btn-success ip-capture">Take photo</button><button class="btn btn-default ip-cancel">Cancel</button></div>',o=function(){return t.modalTemplate||'<div class="ip-modal imgPicker"><div class="ip-dialog"><div class="ip-header"><a class="ip-close">&times;</a><h1>'+t.title+"</h1></div>"+s+"</div></div>"},u=function(){return t.inlineTemplate||'<div class="imgPicker">'+s+"</div>"},a=function(){if(e(".imgPicker").length)e(".imgPicker").remove();if(r)r.stop()},f=function(){e(".cropper-image, .cropper-handle").attr("style","");e(".cropper-container, .webcam-container, .ip-save, .ip-capture").hide();l(0);if(r)r.stop();for(i in v)v[i]=0;v.s=1},l=function(t,n){var r=e(".ip-alert");if(t==0&!n){r.hide();return}r.find("span").text(t);switch(n){case 1:r.removeClass("alert-danger").addClass("alert-warning");break;case 2:r.removeClass("alert-warning").addClass("alert-danger");break}r.show();r.on("click",".dismiss",function(t){t.preventDefault();e(".ip-alert").hide()})},c=function(){return!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)},h=function(){return!!("ontouchstart"in window)},p=function(){return t.timestamp?"?"+(new Date).getTime():""},d=function(e,t){var n,r,i=function(e,t){if(t===0)return e;return i(t,e%t)},s=function(e){return/^[0-9]+$/.test(e)};if(!s(e)||!s(t))return[0,0];if(e===t)return[1,1];if(+e<+t){n=e;e=t;t=n}r=i(+e,+t);return"undefined"===typeof n?[e/r,t/r]:[t/r,e/r]},v={ow:0,oh:0,w:0,h:0,at:0,al:0,t:0,l:0,s:1},m,g=function(e){var t=v.s;v.s=e||v.s;m.css({width:v.w*v.s,height:v.h*v.s});y({t:-(v.h*t-v.h*v.s)/2,l:-(v.w*t-v.w*v.s)/2})},y=function(t){var n=e(".cropper-mask");v.t+=t.t;v.l+=t.l;var r=v.at-v.t,i=v.al-v.l;if(r>40){r=40;v.t=v.at==40?0:-40}else if(r<-(v.h*v.s-(n.height()-40))){r=-(v.h*v.s-(n.height()-40));v.t=v.at==40?v.h*v.s-(n.height()-80):v.h*v.s-(n.height()-40)}if(i>40){i=40;v.l=v.al==40?0:-40}else if(i<-(v.w*v.s-(n.width()-40))){i=-(v.w*v.s-(n.width()-40));v.l=v.al==40?v.w*v.s-(n.width()-80):v.w*v.s-(n.width()-40)}m.css({top:r,left:i})},b=function(n){var r=e(".cropper-mask"),i=new Image;m=e(".cropper-image");i.onload=function(){t.minWidth=t.minWidth||1;t.minHeight=t.minHeight||1;if(i.width<t.minWidth)return l("Image requires a minimum width of "+t.minWidth+"px",2);if(i.width<t.minHeight)return l("Image requires a minimum height of "+t.minHeight+"px",2);if(t.maxWidth&&i.width>t.maxWidth)return l("Image exceeds maximum width of "+t.maxWidth+"px",2);if(t.maxHeight&&i.width>t.maxHeight)return l("Image exceeds maximum height of "+t.maxHeight+"px",2);var s;if(t.aspectRatio)s=(t.aspectRatio||"").split(/:/);else if(e(t.el).length)s=d(e(t.el).width(),e(t.el).height());else s=d(i.width,i.height);var o=t.width-30,u=o*s[0],a=o*s[1];if(u>o){a=a/u*o;u=o}if(a>o){u=u/a*o;a=o}var f=function(e){return e*(40*2/o)};if(u>a)a+=f(u-a);else if(a>u)u+=f(a-u);r.css({width:u,height:a,"margin-left":u<o?(a-u)/2:0});m.attr("src",n);var c=i.width,h=i.height,s={wh:r.width()/r.height(),hw:r.height()/r.width()};v.ow=c;v.oh=h;if(c*s.hw<h*s.wh){v.w=r.width()-40*2;v.h=v.w*(h/c);v.al=40}else{v.h=r.height()-40*2;v.w=v.h*(c/h);v.at=40}g();e(".cropper-container, .ip-save").show();w();E();e(".ip-save").on("click",function(){S(n)})};i.src=n},w=function(){e(".cropper-overlay").on("mousedown touchstart",function(t){var n=e(this),r={x:t.pageX||t.originalEvent.changedTouches[0].pageX,y:t.pageY||t.originalEvent.changedTouches[0].pageY},i={x:n.parent().offset().left,y:n.parent().offset().top};t.preventDefault();e(document).on("mousemove touchmove",function(t){if(t.pageX||t.originalEvent.changedTouches&&typeof t.originalEvent.changedTouches[0]!==undefined){var s={x:t.pageX||t.originalEvent.changedTouches[0].pageX,y:t.pageY||t.originalEvent.changedTouches[0].pageY};if(parseInt(n.css("top"))==0){n.css({top:e(".cropper-mask").offset().top,left:e(".cropper-mask").offset().left})}y({t:parseInt(n.css("top"))-(i.y-(r.y-s.y)),l:parseInt(n.css("left"))-(i.x-(r.x-s.x))});n.css({left:i.x-(r.x-s.x),top:i.y-(r.y-s.y)})}});e(document).on("mouseup touchend",function(){e(document).unbind("mousemove touchmove");e(".cropper-overlay").css({top:0,left:0})});return false})},E=function(){var t=e(".cropper-handle"),n=e(".cropper-slider"),r=n[0].offsetWidth;var i=function(e){var i=(((e.pageX||e.originalEvent.changedTouches&&e.originalEvent.changedTouches[0].pageX)-n.offset().left)/r).toFixed(2);if(i<0)i=0;if(i>1)i=1;t.css("margin-left",i*(r-5)-5);g(i*3+1);e.preventDefault()};e(document).on("mousedown touchstart",".cropper-slider",function(n){e(document).on("mousemove touchmove",function(e){if(t.focus())i(e)});if(e(n.target).hasClass("cropper-slider"))t.addClass("transition");i(n)});e(document).on("mouseup touchend",function(){e(document).unbind("mousemove touchmove");t.removeClass("transition")})},S=function(n){var r=e(".cropper-mask");saveBtn=e(".ip-save"),data={action:"save",x:Math.round(-(parseInt(m.css("left"))-40)*(v.ow/(v.w*v.s))),y:Math.round(-(parseInt(m.css("top"))-40)*(v.oh/(v.h*v.s))),width:Math.round((r.width()-40*2)*(v.ow/(v.w*v.s))),height:Math.round((r.height()-40*2)*(v.oh/(v.h*v.s))),type:t.type||"",obj_id:t.obj_id||0,data:t.data||{},image:n};e.ajax({url:t.api,type:"POST",dataType:"json",data:data,beforeSend:function(){saveBtn.prop("disable",true);l("Saving image...",1)}}).done(function(n){if(n.success){if(t.attr=="src")e(t.el).attr("src",n.data+p());else if(e(t.el).length)e(t.el).attr(t.attr,n.data);a();if(t.complete)t.complete(n.data)}else l(n.data,2)}).fail(function(){l("Unexpected error. Try again.",2)}).always(function(){saveBtn.prop("disable",false)})},x=function(t){var n=e(t)[0].files[0],r=/image.*/;if(!n.type)return N(t);if(n.type.match(r)&&n.type!="image/bmp"){l("Uploading...",1);var i=new FileReader;i.onload=function(e){b(i.result);t.parent()[0].reset();l(0)};i.readAsDataURL(n)}else l("Filetype not allowed",2)},T=function(){var n=e(".webcam-container"),i=n.find("video")[0];navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;navigator.getUserMedia({video:true},function(s){r=s;i.src=window.URL.createObjectURL(s);e(i).css("max-width",t.width-30).show();n.show();e(".ip-capture").show();e(".ip-capture, .touch video").on("click",function(){var t=document.createElement("canvas"),r=t.getContext("2d");t.width=i.videoWidth;t.height=i.videoHeight;r.drawImage(i,0,0);var o=t.toDataURL("image/png");s.stop();n.hide();e(".ip-capture").hide();b(o)})},function(e){l("Webcam Error: "+e.name,2)})},N=function(n){var r=e('<iframe id="ip-iframe" name="ip-iframe"></iframe>').css("display","none");e("body").append(r);r.on("load",function(){var t=r.contents().find("body").html();try{var i=jQuery.parseJSON(t)}catch(s){}if(i){if(i.success){l(0);b(i.data+p())}else l(i.data,2)}else l("Error ! (malformed json)",2);setTimeout(function(){e("#ip-form, #ip-iframe").remove();n.parent()[0].reset()},250)});var i=e("<form/>",{id:"ip-form",method:"post",action:t.api,enctype:"multipart/form-data",encoding:"multipart/form-data",target:"ip-iframe"}).css("display","none");var s={action:"upload",type:t.type||"",obj_id:t.obj_id||0};for(var o in s)i.append(e("<input/>",{type:"hidden",name:o,value:s[o]}));e("body").append(i);var u=n.parent();e("#ip-form").append(n);i.submit();u.append(n);l("Uploading...",1)},C=function(){var n=e(".webcam-container"),r=t.width-30,i=t.width*.8;n.find(".preview").html(webcam.get_html(t.swf_url,r,i,r+200,i+200));n.show();e(".ip-capture").on("click",function(){webcam.snap()});webcam.loaded=function(){e(".ip-capture").show()};webcam.complete=function(t){if(t){n.hide();e(".ip-capture").hide();b("data:image/png;base64,"+t)}else C()};webcam.error=function(e){l("Webcam Error: "+e,2)}};return this.each(function(){e(this).on("click",function(){var n=e(t.el);a();if(t.inline){var r=u();e(t.inline).append(r)}else{var r=o();e("body").append(r);e(".ip-dialog").css({width:t.width,marginLeft:-t.width/2})}if(h())e(".imgPicker").addClass("touch");var i=navigator.userAgent.toLowerCase();if(i.indexOf("msie 7.0")>=0)e(".imgPicker").addClass("isIE7");e(".imgPicker").fadeIn();e(".ip-close, .ip-cancel").on("click",function(t){e(".imgPicker").fadeOut(function(){a()});t.preventDefault()});e(".ip-upload .ip-file").on("change",function(){f();if(window.File&&window.FileReader&&window.FileList&&window.Blob&&t.html5Upload)x(e(this));else N(e(this))});e(".ip-webcam").on("click",function(){f();if(c())T();else C()});if(t.open){if(t.open=="upload")e(".ip-upload .ip-file").trigger("click");else if(t.open=="webcam")e(".ip-webcam").trigger("click")}})})}})})(jQuery);window.webcam={_loaded:false,loaded:null,complete:null,error:null,get_html:function(e,t,n,r,i){return'<object id="webcam_movie" type="application/x-shockwave-flash" data="'+e+'" width="'+t+'" height="'+n+'"><param name="wmode" value="transparent"></param><param name="movie" value="'+e+'"/><param name="FlashVars" value="width='+t+"&height="+n+"&server_width="+(r||t)+"&server_height="+(i||n)+'"/><param name="allowScriptAccess" value="always"/></object>'},snap:function(){if(!this._loaded)return alert("ERROR: Movie is not loaded yet");var e=document.getElementById("webcam_movie");if(!e)alert("ERROR: Cannot locate movie webcam_movie in DOM");e._snap()},notify:function(e,t){switch(e){case"loaded":this._loaded=true;this.loaded();break;case"error":this.error(t);break;case"success":this.complete(t);break}}}